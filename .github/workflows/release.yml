name: Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: Speak2
  SCHEME: Speak2

jobs:
  build-and-release:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Import Code Signing Certificate
        env:
          P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION_P12 }}
          P12_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          echo "$P12_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Build Release
        run: |
          swift build -c release

      - name: Create App Bundle
        run: |
          chmod +x scripts/create-app-bundle.sh
          ./scripts/create-app-bundle.sh

      - name: Sign Application
        env:
          SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          # Sign the app bundle
          codesign --force --deep --options runtime \
            --sign "$SIGNING_IDENTITY" \
            --entitlements Sources/Speak2.entitlements \
            "build/$APP_NAME.app"

          # Verify signature
          codesign --verify --verbose "build/$APP_NAME.app"

      - name: Notarize Application
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create zip for notarization
          ditto -c -k --keepParent "build/$APP_NAME.app" "build/$APP_NAME.zip"

          # Submit for notarization
          xcrun notarytool submit "build/$APP_NAME.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "build/$APP_NAME.app"

      - name: Create DMG
        run: |
          chmod +x scripts/create-dmg.sh
          ./scripts/create-dmg.sh

      - name: Get Version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.APP_NAME }} ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            build/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg
          body: |
            ## Installation

            1. Download the DMG file below
            2. Open the DMG and drag Speak2 to your Applications folder
            3. Launch Speak2 from Applications
            4. Grant Accessibility and Microphone permissions when prompted
            5. The speech model (~140MB) will download on first launch

            ## Requirements

            - macOS 14.0 (Sonoma) or later
            - Apple Silicon or Intel Mac
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
